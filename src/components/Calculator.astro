---
import SearchSelect from './SearchSelect.astro';

interface Props {
    intercept: number;
    coefSqft: number;
    coefAge: number;
    coefBath: number;
    coefFee: number;
    coefCondition: number;
    coefRainscreen: number;
    coefAC: number;
    coefEndUnit: number;
    coefDoubleGarage: number;
    coefTandemGarage: number;
    areaCoefficients: Record<string, number>;
    areaReference: string;
    stdError: number;
    tStats: any;
    isLogLinear: boolean;
}

const { 
    intercept, coefSqft, coefAge, coefBath,
    coefFee, coefCondition, coefRainscreen,
    coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage,
    areaCoefficients, areaReference, stdError,
    tStats, isLogLinear
} = Astro.props;

// For display in dropdown, we convert log coefs to approx percentages if log-linear
const areaOptions = Object.entries(areaCoefficients)
    .sort((a, b) => b[1] - a[1])
    .map(([name, val]) => {
        const sig = Math.abs(tStats.areaCoefficients[name]) >= 1.65;
        // If log linear, val is ~ % diff. e.g. 0.10 = +10%
        // We still pass the raw val to the calculator logic
        const percentVal = isLogLinear ? val * 100 : val;
        const formattedMeta = isLogLinear 
            ? `${val > 0 ? '+' : ''}${percentVal.toFixed(1)}%` 
            : `${val > 0 ? '+' : ''}$${Math.abs(val).toLocaleString()}`;
        
        // Determine color class based on significance and value
        let metaClass = 'text-gray-400'; // default grey for low sig
        if (sig) {
            metaClass = val > 0 ? 'text-green-600' : 'text-red-500';
        }
            
        return {
            label: name === areaReference ? `${name} (Baseline)` : name,
            value: val, 
            meta: formattedMeta,
            metaClass: metaClass
        };
    });

const conditionOptions = [
    { label: "1 - Needs Work", value: "1" },
    { label: "2 - Original/Dated", value: "2" },
    { label: "3 - Average", value: "3" },
    { label: "4 - Updated", value: "4" },
    { label: "5 - Brand New/Reno", value: "5" }
];

const parkingOptions = [
    { label: "Underground / Carport / Street", value: "std" },
    { label: "Tandem Private Garage", value: "tandem" },
    { label: "Double Side-by-Side Garage", value: "double" }
];
---

<section id="calculator" class="py-12 bg-gray-50 border-y border-gray-200">
    <div class="max-w-4xl mx-auto px-4 md:px-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row">
            
            <!-- Inputs -->
            <div class="w-full md:w-7/12 p-6 md:p-8 space-y-6 border-b md:border-b-0 md:border-r border-gray-100 rounded-t-xl md:rounded-tr-none md:rounded-l-xl bg-white">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Feature Pricing Calculator</h2>
                    <p class="text-sm text-gray-500 mt-1">
                        {isLogLinear ? 'Log-Linear Model Active.' : 'Linear Model Active.'} 
                        Adjust attributes to see dynamic valuation.
                    </p>
                </div>
                
                <!-- Core -->
                <div class="space-y-4">
                    <SearchSelect 
                        id="inputAreaCoef" 
                        label="Neighborhood / Area" 
                        options={areaOptions}
                        initialValue="0"
                        placeholder="Search for an area..."
                    />
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Year Built</label>
                            <input type="number" id="inputYear" value="2015" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Size (sqft)</label>
                            <input type="number" id="inputArea" value="1500" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                    </div>
                </div>

                <!-- Size & Baths -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Bathrooms</label>
                        <input type="number" id="inputBath" value="2.5" step="0.5" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                    <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Strata Fee ($)</label>
                        <input type="number" id="inputFee" value="350" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                </div>

                <!-- Assessment (NEW) -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Assessed Value ($) <span class="text-xs text-gray-400 font-normal">Optional</span></label>
                    <input type="number" id="inputAssessment" value="0" placeholder="e.g. 850000" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>

                <!-- Condition & Parking -->
                <div class="space-y-4">
                    <SearchSelect 
                        id="inputCondition" 
                        label="Condition (1-5)" 
                        options={conditionOptions}
                        initialValue="3"
                        placeholder="Select condition..."
                    />
                    
                    <SearchSelect 
                        id="inputParking" 
                        label="Parking" 
                        options={parkingOptions}
                        initialValue="std"
                        placeholder="Select parking..."
                    />
                </div>

                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkEndUnit" class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkEndUnit" class="text-sm text-gray-700">End Unit</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkAC" class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkAC" class="text-sm text-gray-700">Air Conditioning</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkRain" class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkRain" class="text-sm text-gray-700">Rainscreened</label>
                    </div>
                </div>
            </div>

            <!-- Outputs -->
            <div class="w-full md:w-5/12 bg-gray-900 text-white p-6 md:p-8 flex flex-col justify-center rounded-b-xl md:rounded-bl-none md:rounded-r-xl relative">
                <div class="mb-8">
                    <span class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Predicted Value</span>
                    <div class="text-4xl md:text-5xl font-serif font-bold text-white tracking-tight" id="outputPrice">$0</div>
                    
                    <!-- Range Display -->
                    <div class="mt-3 flex items-center group relative w-fit z-10">
                        <div class="flex items-center space-x-2 cursor-default">
                            <div class="h-1.5 w-1.5 rounded-full bg-amber-500"></div>
                            <div class="text-sm text-gray-300 font-mono" id="outputRange">$0 — $0</div>
                        </div>
                    </div>
                    
                    <div class="text-gray-500 text-xs mt-2" id="outputPsqft">$0 / sqft</div>
                </div>

                <div class="space-y-3 border-t border-gray-700 pt-6 text-sm">
                    <!-- Dynamic Component Values -->
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Area Premium</span>
                        <span class="text-green-400" id="valLoc">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Age Impact</span>
                        <span class="text-amber-400" id="valAge">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Condition Value</span>
                        <div class="flex items-center gap-2">
                             {Math.abs(tStats.coefCondition) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                             <span class="text-green-400" id="valCondition">+$0</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Bathrooms</span>
                        <div class="flex items-center gap-2">
                            {Math.abs(tStats.coefBath) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                            <span class="text-green-400" id="valBath">+$0</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Parking Value</span>
                        <span class="text-green-400" id="valParking">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Amenities (AC/End)</span>
                        <span class="text-green-400" id="valFeatures">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Fee Adjustment</span>
                        <span class="text-red-400" id="valFee">-$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ intercept, coefSqft, coefAge, coefBath, coefFee, coefCondition, coefRainscreen, coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage, stdError, isLogLinear }}>
    document.addEventListener('DOMContentLoaded', () => {
        
        const inputs = {
            areaCoef: document.getElementById('inputAreaCoef'),
            year: document.getElementById('inputYear'),
            area: document.getElementById('inputArea'),
            bath: document.getElementById('inputBath'),
            fee: document.getElementById('inputFee'),
            assessment: document.getElementById('inputAssessment'),
            condition: document.getElementById('inputCondition'),
            parking: document.getElementById('inputParking'),
            endUnit: document.getElementById('checkEndUnit'),
            ac: document.getElementById('checkAC'),
            rain: document.getElementById('checkRain')
        };

        const outputs = {
            price: document.getElementById('outputPrice'),
            range: document.getElementById('outputRange'),
            psqft: document.getElementById('outputPsqft'),
            valAge: document.getElementById('valAge'),
            valFee: document.getElementById('valFee'),
            valBath: document.getElementById('valBath'),
            valCondition: document.getElementById('valCondition'),
            valParking: document.getElementById('valParking'),
            valFeatures: document.getElementById('valFeatures'),
            valLoc: document.getElementById('valLoc')
        };

        function format(num) {
            return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
        }

        // Helper: Calculate Price given specific overrides
        function predict(overrides = {}) {
            // Defaults
            let areaCoefVal = parseFloat(inputs.areaCoef.value) || 0;
            let year = parseFloat(inputs.year.value);
            let area = parseFloat(inputs.area.value);
            let bath = parseFloat(inputs.bath.value);
            let fee = parseFloat(inputs.fee.value) || 0;
            let condition = parseInt(inputs.condition.value) || 3;
            let parkType = inputs.parking.value;
            let isEnd = inputs.endUnit.checked ? 1 : 0;
            let isAC = inputs.ac.checked ? 1 : 0;
            let isRain = inputs.rain.checked ? 1 : 0;

            // Apply overrides
            if (overrides.areaCoefVal !== undefined) areaCoefVal = overrides.areaCoefVal;
            if (overrides.year !== undefined) year = overrides.year;
            // ... add others if needed for diff calculation, currently simplified to core vars

            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            const feePerSqft = area > 0 ? fee / area : 0;

            // Parking
            let valParkingCoef = 0;
            if (parkType === 'double') valParkingCoef = coefDoubleGarage;
            if (parkType === 'tandem') valParkingCoef = coefTandemGarage;

            if (isLogLinear) {
                // ln(Price) = Intercept + Coefs...
                const logPrice = intercept + 
                    (area * coefSqft) + 
                    (age * coefAge) + 
                    (bath * coefBath) + 
                    (feePerSqft * coefFee) + 
                    (condition * coefCondition) + 
                    (isRain * coefRainscreen) + 
                    (isEnd * coefEndUnit) + 
                    (isAC * coefAC) + 
                    valParkingCoef + 
                    areaCoefVal;
                
                return Math.exp(logPrice);
            } else {
                // Linear fallback
                return intercept + 
                    (area * coefSqft) + 
                    (age * coefAge) + 
                    (bath * coefBath) + 
                    (feePerSqft * coefFee) + 
                    (condition * coefCondition) + 
                    (isRain * coefRainscreen) + 
                    (isEnd * coefEndUnit) + 
                    (isAC * coefAC) + 
                    valParkingCoef + 
                    areaCoefVal;
            }
        }

        function calculate() {
            // 1. Calculate Baseline Total
            const finalPrice = predict();
            const area = parseFloat(inputs.area.value);
            const year = parseFloat(inputs.year.value);

            // 2. Render Main Price
            outputs.price.innerText = format(finalPrice);
            outputs.psqft.innerText = format(finalPrice / area) + " / sqft";

            // 3. Render Range (Log Scale Error)
            let lowerBound, upperBound;
            if (isLogLinear) {
                // Error is multiplicative in log scale
                // Lower = exp(ln(price) - z*sigma) = price * exp(-z*sigma)
                // Approx +/- 80% CI (z=1.28)
                const margin = Math.exp(1.28 * stdError);
                lowerBound = finalPrice / margin;
                upperBound = finalPrice * margin;
            } else {
                lowerBound = finalPrice - (1.28 * stdError);
                upperBound = finalPrice + (1.28 * stdError);
            }
            outputs.range.innerText = `${format(lowerBound)} — ${format(upperBound)}`;

            // 4. Calculate Component Values by Difference
            // To find the value of "Location", we compare Current Price vs Price if LocCoef was 0
            // BUT for additive components (like Bath), we compare Current vs Price if Bath was 0 (or standard 1)
            
            // Helper for Value Diff
            const getDiff = (currentVal, zeroVal) => {
                return currentVal - zeroVal;
            };

            // Area Value
            // For Log Linear: P_with_area - P_no_area
            const pNoArea = finalPrice / Math.exp(parseFloat(inputs.areaCoef.value) || 0); // Simplified inverse
            const valLoc = finalPrice - pNoArea;
            outputs.valLoc.className = valLoc >= 0 ? "text-green-400" : "text-red-400";
            outputs.valLoc.innerText = (valLoc > 0 ? "+" : "") + format(valLoc);

            // Age Impact (Compare to 0 age)
            const age = new Date().getFullYear() - year;
            const pNew = finalPrice / Math.exp(age * coefAge);
            const valAge = finalPrice - pNew;
            outputs.valAge.innerText = format(valAge); // Usually negative

            // Condition (Compare to condition 3 baseline if desired, or 0)
            // Let's compare to Condition 1 (lowest) to show "Value added by condition"
            const cond = parseInt(inputs.condition.value) || 3;
            // Diff from Cond 1
            const pCond1 = finalPrice / Math.exp((cond - 1) * coefCondition);
            const valCond = finalPrice - pCond1;
            outputs.valCondition.innerText = "+" + format(valCond);

            // Baths (Value of EXTRA baths, e.g. above 1)
            const bath = parseFloat(inputs.bath.value);
            const p1Bath = finalPrice / Math.exp((bath - 1) * coefBath);
            const valBath = finalPrice - p1Bath;
            outputs.valBath.innerText = "+" + format(valBath);

            // Parking (Value vs Street)
            const parkType = inputs.parking.value;
            let parkCoef = 0;
            if (parkType === 'double') parkCoef = coefDoubleGarage;
            if (parkType === 'tandem') parkCoef = coefTandemGarage;
            const pStdPark = finalPrice / Math.exp(parkCoef);
            const valPark = finalPrice - pStdPark;
            outputs.valParking.innerText = "+" + format(valPark);

            // Amenities (End + AC + Rain)
            const isEnd = inputs.endUnit.checked ? 1 : 0;
            const isAC = inputs.ac.checked ? 1 : 0;
            const isRain = inputs.rain.checked ? 1 : 0;
            const amenitiesCoef = (isEnd * coefEndUnit) + (isAC * coefAC) + (isRain * coefRainscreen);
            const pNoAmenities = finalPrice / Math.exp(amenitiesCoef);
            const valAmenities = finalPrice - pNoAmenities;
            outputs.valFeatures.innerText = "+" + format(valAmenities);

            // Fee Impact (Value vs $0 fee)
            // Fee coefficient is usually negative
            const fee = parseFloat(inputs.fee.value) || 0;
            const feePerSqft = area > 0 ? fee / area : 0;
            const pNoFee = finalPrice / Math.exp(feePerSqft * coefFee);
            const valFee = finalPrice - pNoFee;
            outputs.valFee.innerText = format(valFee);

            // Dispatch event for charts
            const event = new CustomEvent('deprecity:model-update', {
                detail: {
                    price: finalPrice,
                    sqft: area,
                    year: year
                }
            });
            document.dispatchEvent(event);
        }

        // Attach Listeners
        Object.values(inputs).forEach(input => {
            if(input) {
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
            }
        });

        const tryCalculate = () => {
            if (document.getElementById('chartPriceSize')) {
                calculate();
            } else {
                document.addEventListener('charts-ready', () => calculate(), { once: true });
            }
        };
        
        setTimeout(tryCalculate, 50);
    });
</script>
