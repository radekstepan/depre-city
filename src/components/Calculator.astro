---
import SearchSelect from './SearchSelect.astro';
import { CALCULATOR_DEFAULTS } from '../config/calculator';

interface Props {
    intercept: number;
    coefSqft: number;
    coefAge: number;
    coefBath: number;
    coefBedrooms: number;
    coefCondition: number;
    coefRainscreen: number;
    coefAC: number;
    coefEndUnit: number;
    coefDoubleGarage: number;
    coefTandemGarage: number;
    coefExtraParking: number;
    coefAssessment: number;
    coefHasAssessment: number;
    coefTax: number;
    coefHasTax: number;
    coefFeePerSqft: number;
    areaCoefficients: Record<string, number>;
    areaReference: string;
    stdError: number;
    tStats: any;
    isLogLinear: boolean;
}

const {
    intercept, coefSqft, coefAge, coefBath, coefBedrooms,
    coefCondition, coefRainscreen,
    coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage, coefExtraParking,
    coefAssessment, coefHasAssessment, coefTax, coefHasTax, coefFeePerSqft,
    areaCoefficients, areaReference, stdError,
    tStats, isLogLinear
} = Astro.props;

// For display in dropdown, we convert log coefs to approx percentages if log-linear
const areaOptions = Object.entries(areaCoefficients)
    .sort((a, b) => b[1] - a[1])
    .map(([name, val]) => {
        const sig = Math.abs(tStats.areaCoefficients[name]) >= 1.65;
        // If log linear, val is ~ % diff. e.g. 0.10 = +10%
        // We still pass the raw val to the calculator logic
        const percentVal = isLogLinear ? val * 100 : val;
        const formattedMeta = isLogLinear 
            ? `${val > 0 ? '+' : ''}${percentVal.toFixed(1)}%` 
            : `${val > 0 ? '+' : ''}$${Math.abs(val).toLocaleString()}`;
        
        // Determine color class based on significance and value
        let metaClass = 'text-gray-400'; // default grey for low sig
        if (sig) {
            metaClass = val > 0 ? 'text-green-600' : 'text-red-500';
        }
            
        return {
            label: name === areaReference ? `${name} (Baseline)` : name,
            value: val, 
            meta: formattedMeta,
            metaClass: metaClass
        };
    });

const conditionOptions = [
    { label: "1 - Needs Work", value: "1" },
    { label: "2 - Original/Dated", value: "2" },
    { label: "3 - Average", value: "3" },
    { label: "4 - Updated", value: "4" },
    { label: "5 - Brand New/Reno", value: "5" }
];

const parkingOptions = [
    { label: "Underground / Carport / Street", value: "std" },
    { label: "Tandem Private Garage", value: "tandem" },
    { label: "Double Side-by-Side Garage", value: "double" }
];
---

<section 
    id="calculator" 
    class="py-12 bg-gray-50 border-y border-gray-200"
    data-model={JSON.stringify({
        intercept, coefSqft, coefAge, coefBath, coefBedrooms,
        coefCondition, coefRainscreen,
        coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage, coefExtraParking,
        coefAssessment, coefHasAssessment, coefTax, coefHasTax, coefFeePerSqft,
        stdError, isLogLinear
    })}
    data-defaults={JSON.stringify(CALCULATOR_DEFAULTS)}
>
    <div class="max-w-4xl mx-auto px-4 md:px-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row">
            
            <!-- Inputs -->
            <div class="w-full md:w-7/12 p-6 md:p-8 space-y-6 border-b md:border-b-0 md:border-r border-gray-100 rounded-t-xl md:rounded-tr-none md:rounded-l-xl bg-white">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Feature Pricing Calculator</h2>
                    <p class="text-sm text-gray-500 mt-1">
                        {isLogLinear ? 'Log-Linear Model Active.' : 'Linear Model Active.'} 
                        Adjust attributes to see dynamic valuation.
                    </p>
                </div>
                
                <!-- Core -->
                <div class="space-y-4">
                    <SearchSelect 
                        id="inputAreaCoef" 
                        label="Neighborhood / Area" 
                        options={areaOptions}
                        initialValue="0"
                        placeholder="Search for an area..."
                    />
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Year Built</label>
                            <input type="number" id="inputYear" value={CALCULATOR_DEFAULTS.year} class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Size (sqft)</label>
                            <input type="number" id="inputArea" value={CALCULATOR_DEFAULTS.sqft} class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                    </div>
                </div>

                <!-- Size & Baths -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Bathrooms</label>
                        <input type="number" id="inputBath" value={CALCULATOR_DEFAULTS.bathrooms} step="0.5" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Bedrooms</label>
                        <input type="number" id="inputBeds" value={CALCULATOR_DEFAULTS.bedrooms} step="0.5" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none" placeholder="3 or 2.5 (w/ den)">
                    </div>
                </div>

                  <!-- Property Tax -->
                  <div>
                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Property Tax (Annual $)</label>
                      <input type="number" id="inputPropertyTax" value={CALCULATOR_DEFAULTS.propertyTax} step="100" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                  </div>

                  <!-- Strata Fee -->
                  <div>
                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Strata Fee (Monthly $)</label>
                      <input type="number" id="inputStrataFee" value={CALCULATOR_DEFAULTS.fee} step="10" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                  </div>

                  <!-- Assessment -->
                  <div>
                      <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">BC Assessment ($)</label>
                      <input type="number" id="inputAssessment" value={CALCULATOR_DEFAULTS.assessment} step="10000" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                  </div>

                 <!-- Condition & Parking -->
                 <div class="space-y-4">
                      <SearchSelect
                          id="inputCondition"
                          label="Condition (1-5)"
                          options={conditionOptions}
                          initialValue={CALCULATOR_DEFAULTS.condition.toString()}
                          placeholder="Select condition..."
                      />

                      <SearchSelect
                          id="inputParking"
                          label="Parking Type"
                          options={parkingOptions}
                          initialValue={CALCULATOR_DEFAULTS.parkingType}
                          placeholder="Select parking..."
                      />

                      <div>
                          <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Parking Spots</label>
                          <input type="number" id="inputParkingSpots" value={CALCULATOR_DEFAULTS.parkingSpots} min="1" step="1" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                      </div>
                  </div>

                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkEndUnit" checked={CALCULATOR_DEFAULTS.isEndUnit} class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkEndUnit" class="text-sm text-gray-700">End Unit</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkAC" checked={CALCULATOR_DEFAULTS.hasAC} class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkAC" class="text-sm text-gray-700">Air Conditioning</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="checkRain" checked={CALCULATOR_DEFAULTS.isRainscreened} class="h-4 w-4 text-amber-600 rounded">
                        <label for="checkRain" class="text-sm text-gray-700">Rainscreened</label>
                    </div>
                </div>
            </div>

            <!-- Outputs -->
            <div class="w-full md:w-5/12 bg-gray-900 text-white p-6 md:p-8 flex flex-col justify-center rounded-b-xl md:rounded-bl-none md:rounded-r-xl relative">
                <div class="mb-8">
                    <span class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Predicted Value</span>
                    <div class="text-4xl md:text-5xl font-serif font-bold text-white tracking-tight" id="outputPrice">$0</div>
                    
                    <!-- Range Display -->
                    <div class="mt-3 flex items-center group relative w-fit z-10">
                        <div class="flex items-center space-x-2 cursor-default">
                            <div class="text-sm text-gray-300 font-mono" id="outputRange">$0 — $0</div>
                        </div>
                    </div>
                    
                    <div class="text-gray-500 text-xs mt-2" id="outputPsqft">$0 / sqft</div>
                </div>

                <div class="space-y-3 border-t border-gray-700 pt-6 text-sm">
                    <!-- Dynamic Component Values -->
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Area Premium</span>
                        <span class="text-green-400" id="valLoc">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Age Impact</span>
                        <span class="text-amber-400" id="valAge">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Condition Value</span>
                        <div class="flex items-center gap-2">
                             {Math.abs(tStats.coefCondition) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                             <span class="text-green-400" id="valCondition">+$0</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Bathrooms</span>
                        <div class="flex items-center gap-2">
                            {Math.abs(tStats.coefBath) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                            <span class="text-green-400" id="valBath">+$0</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Bedrooms</span>
                        <div class="flex items-center gap-2">
                            {Math.abs(tStats.coefBedrooms) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                            <span class="text-green-400" id="valBeds">+$0</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Parking Value</span>
                        <span class="text-green-400" id="valParking">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Amenities (AC/End)</span>
                        <span class="text-green-400" id="valFeatures">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">BC Assessment Alignment</span>
                            {Math.abs(tStats.coefAssessment) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                        </div>
                        <span class="text-green-400" id="valAssessment">+$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">Tax Adjustment</span>
                            {Math.abs(tStats.coefTax) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                        </div>
                        <span class="text-red-400" id="valTax">-$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">Strata Fee Impact</span>
                            {Math.abs(tStats.coefFeePerSqft) < 1.65 && <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded">Low Sig</span>}
                        </div>
                        <span class="text-red-400" id="valFee">-$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    import { predictPrice, calculatePriceRange, calculateComponentImpacts } from '../utils/calculator.js';

    document.addEventListener('DOMContentLoaded', () => {
        const calculatorSection = document.getElementById('calculator');
        const model = JSON.parse(calculatorSection.dataset.model);
        const defaults = JSON.parse(calculatorSection.dataset.defaults);

        const inputs = {
            areaCoef: document.getElementById('inputAreaCoef'),
            year: document.getElementById('inputYear'),
            area: document.getElementById('inputArea'),
            bath: document.getElementById('inputBath'),
            beds: document.getElementById('inputBeds'),
            assessment: document.getElementById('inputAssessment'),
            propertyTax: document.getElementById('inputPropertyTax'),
            strataFee: document.getElementById('inputStrataFee'),
            condition: document.getElementById('inputCondition'),
            parking: document.getElementById('inputParking'),
            parkingSpots: document.getElementById('inputParkingSpots'),
            endUnit: document.getElementById('checkEndUnit'),
            ac: document.getElementById('checkAC'),
            rain: document.getElementById('checkRain')
        };

        const outputs = {
            price: document.getElementById('outputPrice'),
            range: document.getElementById('outputRange'),
            psqft: document.getElementById('outputPsqft'),
            valAge: document.getElementById('valAge'),
            valTax: document.getElementById('valTax'),
            valFee: document.getElementById('valFee'),
            valAssessment: document.getElementById('valAssessment'),
            valBath: document.getElementById('valBath'),
            valBeds: document.getElementById('valBeds'),
            valCondition: document.getElementById('valCondition'),
            valParking: document.getElementById('valParking'),
            valFeatures: document.getElementById('valFeatures'),
            valLoc: document.getElementById('valLoc')
        };

        function format(num) {
            return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
        }

        function updateOutput(element, newValue, key, formatter = format, isPrice = false) {
            const oldValue = previousValues[key];
            
            if (typeof newValue === 'number' && typeof oldValue === 'number' && oldValue !== 0 && Math.abs(newValue - oldValue) > 0.01) {
                animateValue(element, oldValue, newValue, 600, formatter);
                previousValues[key] = newValue;
            } else {
                let formattedNew = typeof formatter === 'function' ? formatter(newValue) : newValue;
                element.textContent = formattedNew;
                previousValues[key] = newValue;
            }
        }
        
        function animateValue(element, start, end, duration, formatter) {
            const startTime = performance.now();
            const diff = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const current = start + (diff * easeProgress);
                element.textContent = formatter(current);
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = formatter(end);
                }
            }
            
            requestAnimationFrame(update);
        }

        function getInputs() {
            return {
                areaCoefVal: parseFloat(inputs.areaCoef.value) || defaults.areaCoefVal,
                year: parseFloat(inputs.year.value) || defaults.year,
                sqft: parseFloat(inputs.area.value) || defaults.sqft,
                bathrooms: parseFloat(inputs.bath.value) || defaults.bathrooms,
                bedrooms: parseFloat(inputs.beds.value) || defaults.bedrooms,
                assessment: parseFloat(inputs.assessment.value) || defaults.assessment,
                propertyTax: parseFloat(inputs.propertyTax.value) || defaults.propertyTax,
                strataFee: parseFloat(inputs.strataFee.value) || defaults.fee,
                condition: parseInt(inputs.condition.value) || defaults.condition,
                parkingType: inputs.parking.value || defaults.parkingType,
                parkingSpots: parseFloat(inputs.parkingSpots.value) || defaults.parkingSpots,
                isEndUnit: inputs.endUnit.checked,
                hasAC: inputs.ac.checked,
                isRainscreened: inputs.rain.checked
            };
        }

        // Store previous values for diff display
        let previousValues = {
            price: 0,
            range: '',
            psqft: 0,
            valAge: 0,
            valTax: 0,
            valFee: 0,
            valAssessment: 0,
            valBath: 0,
            valBeds: 0,
            valCondition: 0,
            valParking: 0,
            valFeatures: 0,
            valLoc: 0
        };

        function calculate() {
            const inputsData = getInputs();
            const finalPrice = predictPrice(inputsData, model);
            const area = inputsData.sqft;
            const year = inputsData.year;

            updateOutput(outputs.price, finalPrice, 'price');
            updateOutput(outputs.psqft, finalPrice / area, 'psqft', (val) => format(val) + " / sqft");

            const { lowerBound, upperBound } = calculatePriceRange(finalPrice, model);
            const rangeText = `${format(lowerBound)} — ${format(upperBound)}`;
            updateOutput(outputs.range, rangeText, 'range', (val) => val);

            const impacts = calculateComponentImpacts(inputsData, model);
            outputs.valLoc.className = impacts.valLoc >= 0 ? "text-green-400" : "text-red-400";
            updateOutput(outputs.valLoc, impacts.valLoc, 'valLoc', (val) => (val > 0 ? "+" : "") + format(val));
            updateOutput(outputs.valAge, impacts.valAge, 'valAge');
            updateOutput(outputs.valCondition, impacts.valCondition, 'valCondition', (val) => "+" + format(val));
            updateOutput(outputs.valBath, impacts.valBath, 'valBath', (val) => "+" + format(val));
            updateOutput(outputs.valBeds, impacts.valBeds, 'valBeds', (val) => "+" + format(val));
            updateOutput(outputs.valParking, impacts.valParking, 'valParking', (val) => "+" + format(val));
            updateOutput(outputs.valFeatures, impacts.valFeatures, 'valFeatures', (val) => "+" + format(val));
            outputs.valAssessment.className = impacts.valAssessment >= 0 ? "text-green-400" : "text-red-400";
            updateOutput(outputs.valAssessment, impacts.valAssessment, 'valAssessment', (val) => (val > 0 ? "+" : "") + format(val));
            outputs.valTax.className = impacts.valTax >= 0 ? "text-green-400" : "text-red-400";
            updateOutput(outputs.valTax, impacts.valTax, 'valTax');
            outputs.valFee.className = impacts.valFee >= 0 ? "text-green-400" : "text-red-400";
            updateOutput(outputs.valFee, impacts.valFee, 'valFee');

            const event = new CustomEvent('deprecity:model-update', {
                detail: {
                    price: finalPrice,
                    sqft: area,
                    year: year
                }
            });
            document.dispatchEvent(event);
        }

        // Attach Listeners
        Object.values(inputs).forEach(input => {
            if(input) {
                const inputType = input.type;
                
                if (inputType === 'hidden') {
                    // Hidden inputs (from SearchSelect) - calculate on change
                    input.addEventListener('change', calculate);
                } else if (inputType === 'number' || inputType === 'text') {
                    // Number/text inputs - calculate on blur, Enter/Esc, or when arrows are used
                    input.addEventListener('blur', calculate);
                    input.addEventListener('change', calculate); // Fires when arrows are used
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === 'Escape' || e.key === 'Tab') {
                            calculate();
                            if (e.key === 'Escape') {
                                input.blur();
                            }
                        }
                    });
                } else {
                    // For checkboxes, calculate immediately on change
                    input.addEventListener('change', calculate);
                }
            }
        });

        const tryCalculate = () => {
            if (document.getElementById('chartPriceSize')) {
                calculate();
            } else {
                document.addEventListener('charts-ready', () => calculate(), { once: true });
            }
        };
        
        setTimeout(tryCalculate, 50);
    });
</script>

<style>
</style>
