---
import SearchSelect from './SearchSelect.astro';

interface Props {
    intercept: number;
    coefSqft: number;
    coefAge: number;
    coefBath: number;
    coefFee: number;
    coefCondition: number;
    coefRainscreen: number;
    coefAC: number;
    coefEndUnit: number;
    coefDoubleGarage: number;
    coefTandemGarage: number;
    areaCoefficients: Record<string, number>;
    areaReference: string;
    feeSlope: number;
    feeIntercept: number;
    stdError: number;
}

const { 
    intercept, coefSqft, coefAge, coefBath,
    coefFee, coefCondition, coefRainscreen,
    coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage, 
    areaCoefficients, areaReference, feeSlope, feeIntercept, stdError
} = Astro.props;

// Transform area coefficients for the SearchSelect
const areaOptions = Object.entries(areaCoefficients)
    .sort((a, b) => b[1] - a[1]) // Sort by value desc
    .map(([name, val]) => ({
        label: name === areaReference ? `${name} (Baseline)` : name,
        value: val, // The value input will store the coefficient directly
        meta: val
    }));
---

<section id="calculator" class="py-12 bg-gray-50 border-y border-gray-200">
    <div class="max-w-4xl mx-auto px-4 md:px-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-6 md:p-8 border-b border-gray-100 bg-gray-50">
                <h2 class="text-2xl font-bold text-gray-900">Feature Pricing Calculator</h2>
                <p class="text-sm text-gray-500 mt-1">Adjust property attributes to see their isolated impact on market value.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                
                <!-- Inputs -->
                <div class="col-span-12 md:col-span-7 p-6 md:p-8 space-y-6 border-r border-gray-100">
                    
                    <!-- Core -->
                    <div class="space-y-4">
                        <SearchSelect 
                            id="inputAreaCoef" 
                            label="Neighborhood / Area" 
                            options={areaOptions}
                            initialValue="0"
                            placeholder="Search for an area..."
                        />
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Year Built</label>
                                <input type="number" id="inputYear" value="2015" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Size (sqft)</label>
                                <input type="number" id="inputArea" value="1500" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Size & Baths -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Bathrooms</label>
                            <input type="number" id="inputBath" value="2.5" step="0.5" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Strata Fee ($)</label>
                            <input type="number" id="inputFee" value="350" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                    </div>

                    <!-- Quality / Fees -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Condition (1-5)</label>
                        <select id="inputCondition" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                            <option value="1">1 - Needs Work</option>
                            <option value="2">2 - Original/Dated</option>
                            <option value="3" selected>3 - Average</option>
                            <option value="4">4 - Updated</option>
                            <option value="5">5 - Brand New/Reno</option>
                        </select>
                    </div>

                    <!-- Deep Data -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Parking Situation</label>
                        <select id="inputParking" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none">
                            <option value="std">Underground / Carport / Street</option>
                            <option value="tandem">Tandem Private Garage</option>
                            <option value="double">Double Side-by-Side Garage</option>
                        </select>
                    </div>

                    <div class="flex flex-wrap gap-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkEndUnit" class="h-4 w-4 text-amber-600 rounded">
                            <label for="checkEndUnit" class="text-sm text-gray-700">End Unit</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkAC" class="h-4 w-4 text-amber-600 rounded">
                            <label for="checkAC" class="text-sm text-gray-700">Air Conditioning</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkRain" class="h-4 w-4 text-amber-600 rounded">
                            <label for="checkRain" class="text-sm text-gray-700">Rainscreened</label>
                        </div>
                    </div>
                </div>

                <!-- Outputs -->
                <div class="col-span-12 md:col-span-5 bg-gray-900 text-white p-6 md:p-8 flex flex-col justify-center">
                    <div class="mb-8">
                        <span class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Predicted Value</span>
                        <div class="text-4xl md:text-5xl font-serif font-bold text-white tracking-tight" id="outputPrice">$0</div>
                        
                        <!-- Range Display -->
                        <div class="mt-2 flex items-center space-x-2">
                            <div class="h-1.5 w-1.5 rounded-full bg-amber-500"></div>
                            <div class="text-sm text-gray-300 font-mono" id="outputRange">Range: $0 - $0</div>
                        </div>
                        
                        <div class="text-gray-500 text-xs mt-2" id="outputPsqft">$0 / sqft</div>
                    </div>

                    <div class="space-y-3 border-t border-gray-700 pt-6 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Base (Intercept)</span>
                            <span class="text-gray-500">${intercept.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Area Adjustment</span>
                            <span class="text-green-400" id="valLoc">+$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Size Value</span>
                            <span class="text-green-400" id="valSize">+$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Age Impact</span>
                            <span class="text-amber-400" id="valAge">+$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Strata Fee Impact</span>
                            <span class="text-red-400" id="valFee">-$0</span>
                        </div>
                         <div class="flex justify-between">
                            <span class="text-gray-400">Bathrooms</span>
                            <span class="text-green-400" id="valBath">+$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Condition/Rainscreen</span>
                            <span class="text-green-400" id="valQuality">+$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Features</span>
                            <span class="text-green-400" id="valFeatures">+$0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ intercept, coefSqft, coefAge, coefBath, coefFee, coefCondition, coefRainscreen, coefAC, coefEndUnit, coefDoubleGarage, coefTandemGarage, stdError }}>
    document.addEventListener('DOMContentLoaded', () => {
        
        const inputs = {
            areaCoef: document.getElementById('inputAreaCoef'), // This is the hidden input from SearchSelect
            year: document.getElementById('inputYear'),
            area: document.getElementById('inputArea'),
            bath: document.getElementById('inputBath'),
            fee: document.getElementById('inputFee'),
            condition: document.getElementById('inputCondition'),
            parking: document.getElementById('inputParking'),
            endUnit: document.getElementById('checkEndUnit'),
            ac: document.getElementById('checkAC'),
            rain: document.getElementById('checkRain')
        };

        const outputs = {
            price: document.getElementById('outputPrice'),
            range: document.getElementById('outputRange'),
            psqft: document.getElementById('outputPsqft'),
            valSize: document.getElementById('valSize'),
            valAge: document.getElementById('valAge'),
            valFee: document.getElementById('valFee'),
            valBath: document.getElementById('valBath'),
            valQuality: document.getElementById('valQuality'),
            valFeatures: document.getElementById('valFeatures'),
            valLoc: document.getElementById('valLoc')
        };

        function format(num) {
            return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
        }

        function calculate() {
            // Get Values
            const areaCoefVal = parseFloat(inputs.areaCoef.value) || 0;
            const year = parseFloat(inputs.year.value);
            const area = parseFloat(inputs.area.value);
            const bath = parseFloat(inputs.bath.value);
            const fee = parseFloat(inputs.fee.value) || 0;
            const condition = parseInt(inputs.condition.value);
            
            const parkType = inputs.parking.value;
            const isEnd = inputs.endUnit.checked ? 1 : 0;
            const isAC = inputs.ac.checked ? 1 : 0;
            const isRain = inputs.rain.checked ? 1 : 0;

            const currentYear = new Date().getFullYear();
            const age = currentYear - year;

            // Compute Component Values
            const valSize = area * coefSqft;
            const valAge = age * coefAge;
            const valBath = bath * coefBath;
            const valFee = fee * coefFee;
            const valCondition = condition * coefCondition;
            const valRain = isRain * coefRainscreen;
            const valEnd = isEnd * coefEndUnit;
            const valAC = isAC * coefAC;
            
            // Parking Logic
            let valParking = 0;
            if (parkType === 'double') valParking = coefDoubleGarage;
            if (parkType === 'tandem') valParking = coefTandemGarage;

            // Total Prediction
            let predictedPrice = intercept + valSize + valAge + valBath + valFee + valCondition + valRain + valEnd + valAC + valParking + areaCoefVal;

            // Range Calculation (95% approx)
            const lowerBound = predictedPrice - (2 * stdError);
            const upperBound = predictedPrice + (2 * stdError);

            // Render
            outputs.price.innerText = format(predictedPrice);
            outputs.range.innerText = `${format(lowerBound)} â€” ${format(upperBound)}`;
            outputs.psqft.innerText = format(predictedPrice / area) + " / sqft";

            outputs.valSize.innerText = (valSize > 0 ? "+" : "") + format(valSize);
            outputs.valAge.innerText = (valAge > 0 ? "+" : "") + format(valAge);
            outputs.valFee.innerText = (valFee > 0 ? "+" : "") + format(valFee);
            outputs.valBath.innerText = (valBath > 0 ? "+" : "") + format(valBath);
            outputs.valQuality.innerText = "+" + format(valCondition + valRain);
            outputs.valFeatures.innerText = "+" + format(valParking + valEnd + valAC);
            
            // Location
            outputs.valLoc.className = areaCoefVal >= 0 ? "text-green-400" : "text-red-400";
            outputs.valLoc.innerText = (areaCoefVal > 0 ? "+" : "") + format(areaCoefVal);

            // Dispatch event for charts
            const event = new CustomEvent('deprecity:model-update', {
                detail: {
                    price: predictedPrice,
                    sqft: area,
                    year: year
                }
            });
            document.dispatchEvent(event);
        }

        // Attach Listeners
        Object.values(inputs).forEach(input => {
            if(input) {
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
            }
        });

        // Initial calculation - wait for charts to be ready
        const tryCalculate = () => {
            if (document.getElementById('chartPriceSize')) {
                calculate();
            } else {
                // Charts not ready yet, wait for them
                document.addEventListener('charts-ready', () => calculate(), { once: true });
            }
        };
        
        // Try immediately or wait a moment
        setTimeout(tryCalculate, 50);
    });
</script>
