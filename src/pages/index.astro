---
import listingData from '../data/listings.json';
import { generateMarketModel } from '../utils/analysis';
import type { Listing } from '../utils/analysis';

// --- Build Time Analysis ---
const listings: Listing[] = listingData as Listing[];
const model = generateMarketModel(listings);

// These variables are injected into the HTML and client-side script
const { baseRateCoq, premiumPM, feeSlope, feeIntercept, generatedAt, sampleSize, modelConfidence } = model;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepreCity | Coquitlam & Port Moody</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; color: #2e2e2e; }
        h1, h2, h3, h4, h5 { font-family: 'Merriweather', serif; }
        .prose-custom p { margin-bottom: 1.5rem; line-height: 1.8; color: #4b5563; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        input[type=range]:focus { outline: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Navigation -->
    <nav class="w-full py-6 border-b border-gray-100 bg-white sticky top-0 z-50 opacity-95">
        <div class="max-w-4xl mx-auto px-6 flex justify-between items-center">
            <div class="text-xl font-bold tracking-tight text-gray-900 font-serif">Depre<span class="text-amber-600">City</span></div>
            <div class="text-right">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Data Current As Of</div>
                <div class="text-xs font-mono text-gray-600">{generatedAt}</div>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <header class="pt-20 pb-16 px-6 bg-white">
        <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 leading-tight mb-6">
                The True Cost of Ownership.
            </h1>
            <p class="text-xl text-gray-500 font-light leading-relaxed">
                Townhouse acquisition in Coquitlam and Port Moody is a multidimensional calculus. 
                Our live regression model detects a <strong>{premiumPM}x</strong> location premium for Port Moody assets.
            </p>
            <div class="mt-6 inline-flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 text-xs font-medium rounded-full border border-green-100">
                <span>Model Confidence (R²): {modelConfidence}</span>
                <span class="w-1 h-1 bg-green-500 rounded-full"></span>
                <span>N = {sampleSize}</span>
            </div>
        </div>
    </header>

    <!-- Calculator Section -->
    <section id="calculator" class="py-12 bg-gray-50 border-y border-gray-200">
        <div class="max-w-4xl mx-auto px-4 md:px-6">
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 md:p-8 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Valuation Calculator</h2>
                        <p class="text-sm text-gray-500 mt-1">Parameters derived from linear regression of market data.</p>
                    </div>
                    <div class="hidden md:block text-right">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Baseline Rate</span>
                        <div class="font-serif font-bold text-gray-700">${baseRateCoq} / sqft</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                    
                    <!-- Inputs -->
                    <div class="col-span-12 md:col-span-7 p-6 md:p-8 space-y-6 border-r border-gray-100">
                        
                        <!-- Location Selection -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Location Context</label>
                            <select id="inputCityMult" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition">
                                <option value="1.0">Coquitlam / PoCo (Baseline)</option>
                                <option value={premiumPM}>Port Moody (Premium)</option>
                            </select>
                        </div>

                        <!-- Property Basics -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Property Basics</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit Size (sqft)</label>
                                    <input type="number" id="inputArea" value="1500" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Year Built</label>
                                    <input type="number" id="inputYear" value="1995" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none transition">
                                </div>
                            </div>
                        </div>

                        <!-- The Drag Factors -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 mt-4">Obsolescence & Risk</label>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subject Strata Fee ($)</label>
                                        <input type="number" id="inputFeeSubject" value="500" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none transition">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Benchmark Fee ($)</label>
                                        <!-- Readonly, calculated via JS based on regression constants -->
                                        <input type="number" id="inputFeeNew" class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-gray-500 cursor-not-allowed" readonly>
                                        <p class="text-[10px] text-gray-400 mt-1">Regression: y = {feeSlope.toFixed(2)}x + {feeIntercept.toFixed(0)}</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CapEx / Levies Forecast ($)</label>
                                    <input type="number" id="inputLevies" value="5000" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 outline-none transition">
                                    <p class="text-xs text-gray-400 mt-1">Immediate renovations + projected levies</p>
                                </div>

                                <div class="flex items-center space-x-3 pt-2">
                                    <input type="checkbox" id="checkRainscreen" class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                                    <label for="checkRainscreen" class="text-sm text-gray-700 select-none">Property is fully Rainscreened</label>
                                </div>
                                <div id="leakyRiskWarning" class="hidden text-xs text-red-600 font-medium bg-red-50 p-2 rounded">
                                    ⚠️ High Risk Era (1985-2000) & Not Rainscreened. $100k Penalty applied.
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Outputs -->
                    <div class="col-span-12 md:col-span-5 bg-gray-900 text-white p-6 md:p-8 flex flex-col justify-center">
                        <div class="mb-8">
                            <span class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Estimated Fair Value</span>
                            <div class="text-4xl md:text-5xl font-serif font-bold text-white tracking-tight" id="outputPrice">$0</div>
                            <div class="text-gray-400 text-sm mt-1" id="outputPsqft">$0 / sqft</div>
                        </div>

                        <div class="space-y-4 border-t border-gray-700 pt-6">
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Base Market Value</span>
                                <span class="text-gray-200" id="detailBase">$0</span>
                            </div>

                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Age Depreciation</span>
                                <span class="text-red-400" id="detailAge">-$0</span>
                            </div>

                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Strata Penalty (NPV)</span>
                                <span class="text-red-400" id="detailStrata">-$0</span>
                            </div>

                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">CapEx / Risk Adjustment</span>
                                <span class="text-red-400" id="detailRisk">-$0</span>
                            </div>

                            <div class="pt-4 mt-2 border-t border-gray-700">
                                <p class="text-xs text-gray-500 leading-relaxed italic">
                                    * Base value derived from recent sales ($<span id="txtBaseRate">{baseRateCoq}</span>/sqft) adjusted for location. Strata Penalty capitalizes excess fees at 5%.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Content: S-Curve Explanation -->
    <main id="report" class="max-w-3xl mx-auto px-6 py-16">
        <div class="prose-custom">
            <h2 class="text-3xl font-bold text-gray-900 font-serif mb-6">The Mathematics of Decay</h2>
            <p>
                Our system rejects the simple linear depreciation model. Townhomes in the Tri-Cities follow a "Bi-Modal S-Curve." Value drops rapidly as the "New Home Premium" (GST + Developer Profit) evaporates in years 1-5, stabilizes during the "Utility Years" (10-25), and then creates a bifurcation event around year 30: <strong>The Rainscreen Event</strong>.
            </p>
        </div>

        <div class="mt-12 mb-12">
            <canvas id="depreciationChart" width="100" height="50"></canvas>
            <p class="text-center text-xs text-gray-400 mt-2">Figure 1: The Depreciation Curve (Visualized)</p>
        </div>
    </main>

    <footer class="bg-gray-900 text-gray-400 py-12 text-center text-sm">
        <p>&copy; 2026 DepreCity. Powered by Astro & Simple-Statistics.</p>
    </footer>

    <!-- Client-Side Logic -->
    <script define:vars={{ baseRateCoq, feeSlope, feeIntercept }}>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Chart.js Visualization ---
            const ctx = document.getElementById('depreciationChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['New', '5 Years', '10 Years', '20 Years', '30 Years', '40 Years', '50 Years', '60 Years'],
                    datasets: [
                        {
                            label: 'Market Price per Sqft',
                            data: [1000, 850, 750, 650, 700, 600, 500, 450],
                            borderColor: '#d97706',
                            backgroundColor: 'rgba(217, 119, 6, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // --- Calculator Logic ---
            const inputs = {
                area: document.getElementById('inputArea'),
                year: document.getElementById('inputYear'),
                feeSubject: document.getElementById('inputFeeSubject'),
                levies: document.getElementById('inputLevies'),
                rainscreen: document.getElementById('checkRainscreen'),
                cityMult: document.getElementById('inputCityMult'),
                feeNew: document.getElementById('inputFeeNew')
            };

            const outputs = {
                price: document.getElementById('outputPrice'),
                psqft: document.getElementById('outputPsqft'),
                base: document.getElementById('detailBase'),
                age: document.getElementById('detailAge'),
                strata: document.getElementById('detailStrata'),
                risk: document.getElementById('detailRisk'),
                riskWarning: document.getElementById('leakyRiskWarning')
            };

            function formatCurrency(num) {
                return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
            }

            function calculate() {
                // 1. Get Values
                const area = parseFloat(inputs.area.value) || 0;
                const yearBuilt = parseFloat(inputs.year.value) || 2000;
                const feeSubject = parseFloat(inputs.feeSubject.value) || 0;
                const levies = parseFloat(inputs.levies.value) || 0;
                const cityMultiplier = parseFloat(inputs.cityMult.value) || 1.0;
                const isRainscreened = inputs.rainscreen.checked;
                const currentYear = new Date().getFullYear();

                // 2. Calculate Benchmark Fee (Regression Model)
                // y = mx + b
                const benchmarkFee = (area * feeSlope) + feeIntercept;
                inputs.feeNew.value = benchmarkFee.toFixed(0);

                // 3. Base Calculation
                // Area * BaseRate * LocationMultiplier
                let baseValue = area * baseRateCoq * cityMultiplier;
                
                // 4. Age Depreciation
                // Simple Model: 1.5% per year, capped at 40% (Land Value floor implication)
                let age = currentYear - yearBuilt;
                if (age < 0) age = 0;
                let depreciationPercent = Math.min(age * 1.5, 40);
                let ageDeduction = baseValue * (depreciationPercent / 100);

                // 5. Strata Penalty (The "Drag")
                // Capitalize excess monthly fees at 5% Cap Rate
                let monthlyExcess = feeSubject - benchmarkFee;
                let strataPenalty = 0;
                if (monthlyExcess > 0) {
                    strataPenalty = (monthlyExcess * 12) / 0.05;
                }

                // 6. Risk / Leaky Era logic
                let riskAdjustment = levies;
                let leakyPenalty = 0;
                
                // Leaky Condo Era logic: 1985-2000
                if (yearBuilt >= 1985 && yearBuilt <= 2000 && !isRainscreened) {
                    leakyPenalty = 100000;
                    outputs.riskWarning.classList.remove('hidden');
                } else {
                    outputs.riskWarning.classList.add('hidden');
                }

                riskAdjustment += leakyPenalty;

                // 7. Final Tally
                let finalValue = baseValue - ageDeduction - strataPenalty - riskAdjustment;

                // 8. Render
                outputs.price.innerText = formatCurrency(finalValue);
                outputs.psqft.innerText = formatCurrency(finalValue / area) + " / sqft";
                
                outputs.base.innerText = formatCurrency(baseValue);
                outputs.age.innerText = "-" + formatCurrency(ageDeduction);
                outputs.strata.innerText = "-" + formatCurrency(strataPenalty);
                outputs.risk.innerText = "-" + formatCurrency(riskAdjustment);
            }

            // Attach Listeners
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
                if (input.type === 'checkbox') input.addEventListener('click', calculate);
            });

            // Initial Calc
            calculate();
        });
    </script>
</body>
</html>
